<!DOCTYPE html>
<meta charset="utf-8" />
<link rel="stylesheet" href="ace_v1.3/assets/css/ui.jqgrid.css" />

<div class="search_panel">
<form action="" id="rechargeSearchForm" method="post" onsubmit="return pageSearch(this);">
	<div style="display: block;" class="widget-body ">
		<div class="widget-main">
			<div class="rowt">
				<div class="col-sm-12">
					<div class="search_elm" style="margin-left: 0px;width:215px">
							<label class="label_search">收款订单号:</label>
							<div class="search_input">
								<input id="prdOrdNo" type="text" name="prdOrdNo" placeholder="请输入订单号" style="width:125px">
							</div>
						</div>
					<div class="search_elm" style="margin-left: 0px;width:200px">
							<label class="label_search">商户编号:</label>
							<div class="search_input" >
								<input id="custId" type="text" name="custId" placeholder="请输入商户编号" style="width:120px">
							</div>
						</div>
						<div class="search_elm" style="margin-left: 0px;width: 180px">
							<label class="label_search">商户名称:</label>
							<div class="search_input" >
								<input id="custName" type="text" name="custName" placeholder="请输入商户名称"  style="width:100px">
							</div>
						</div>
						
						<!-- <div class="search_elm" style="margin-left: 0px">
							<label class="label_search">代理商编号:</label>
							<div class="search_input">
								<input id="agentId" type="text" name="agentId" placeholder="请输入商户名称">
							</div>
						</div> -->
						<div class="search_elm" style="margin-left: 0px">
							<label class="label_search">银行卡号:</label>
							<div class="search_input">
								<input id="bankpayacno" type="text" name="payCardNo" placeholder="请输入银行卡号">
							</div>
						</div>
						
						<!-- <div class="search_elm" style="margin-left: 0px">
							<label class="label_search">开户行:</label>
							<div class="search_input">
								<input id="bankcode" type="text" name="bankcode" placeholder="请输入开户行">
							</div>
						</div> -->
						<div class="search_elm" style="margin-left: 0px;width:200px">
							<label class="label_search">订单状态:</label>
							<div class="search_input">
							<select 
								rel="obj.ORDSTATUS"
								location="local" 
								 name="ordStatus" 
								 id="search_paystatus" 
								  style="width: 120px;vertical-align:middle;">
								  <option value="">---选择---<option>
						 </select>
							</div>
						</div>
						<div class="search_elm" style="margin-left: 0px;width:200px">
							<label class="label_search">审核状态:</label>
							<div class="search_input">
							<select 
								rel="obj.AUDITCONDITION"
								location="local" 
								 name="auditStatus" 
								 id="search_auditstatus" 
								  style="width: 120px;vertical-align:middle;">
								  <option value="">---选择---<option>
						 </select>
							</div>
						</div>
						<div class="search_elm" style="margin-left: 0px;width: 180px">
							<label class="label_search">支付方式:</label>
							<div class="search_input">
							<select 
								rel="obj.PAYTYPE"
								location="local" 
								 name="payType" 
								 id="payType" 
								 style="width: 100px;vertical-align:middle;">
								 <option value="">---选择---<option>
						 </select>
							</div>
						</div>
						<div class="search_elm" style="margin-left: 0px;margin-right: 15px;width: 280px;">
						    <label class="label_search" for="userName">订单时间:</label>
							<div class="input-group">
								<input type="text" class="form-control date-picker"  name="startTime" data-date-format="yyyy-mm-dd" placeholder="起始日期" />
								<span class="input-group-addon">
									<i class="fa fa-exchange"></i>
								</span>
								<input type="text" class="form-control date-picker"  name="endTime" data-date-format="yyyy-mm-dd" placeholder="结束日期" />
							</div>
						</div>
						<div class="search_elm" style="margin-left: 0px">
							<label class="label_search">代理商编号:</label>
							<div class="search_input">
								<input id="agentId" type="text" name="agentId" placeholder="请输入代理商编号" style="width:125px">
							</div>
						</div>
						<div class="search_elm" style="margin-left: 0px;width:215px">
							<label class="label_search">代理商名称:</label>
							<div class="search_input">
								<input id="agentName" type="text" name="agentName" placeholder="请输入代理商名称" style="width:125px">
							</div>
						</div>
						<div class="search_elm" style="margin-left: 0px;width:240px">
							<label class="label_search">父代理商编号:</label>
							<div class="search_input">
								<input id="search_fathAgentId" type="text" name="fathAgentId" placeholder="请输入代理商编号"/>
							</div>
						</div>
						<div class="search_elm" style="margin-left: 0px;width:280px">
							<label class="label_search">一級代理商编号:</label>
							<div class="search_input">
								<input id="search_firstAgentId" type="text" name="firstAgentId" placeholder="请输入代理商编号"/>
							</div>
						</div>
						<div class="search_elm" style="margin-left: 0px;margin-right: 15px;width: 280px;">
						    <label class="label_search" for="userName">审核通过时间:</label>
							<div class="input-group">
								<input type="text" class="form-control date-picker"  name="startTime_audit" data-date-format="yyyymmdd" placeholder="起始日期" />
								<span class="input-group-addon">
									<i class="fa fa-exchange"></i>
								</span>
								<input type="text" class="form-control date-picker"  name="endTime_audit" data-date-format="yyyymmdd" placeholder="结束日期" />
							</div>
						</div>
						<div class="search_elm" style="margin-left: 0px;width: 200px">
							<button class="btn btn-small btn_search" type="submit" title="搜索" onclick="searchCount();">
								搜索
							</button>
							<button class="btn btn-small" onclick="resetForm();" type="reset" title="清空" >
								清空
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div style="display: block;" class="widget-body " id="total">
		
	</div>
	</form>
	
	<div class="row">
		<div class="col-xs-12">
			<table id="grid-table"></table>
			<div id="grid-pager"></div>
			
			<div style="margin-top: 10px">
			
			<span id="auth_btn">
				
				<a auth="mpomng/prdInf/rechargeDetailsView.do" class='btn btn-small btn-warning'
					onclick="rechargeDetails();"> 详细
				</a>
				<a auth=""class='btn btn-small btn-warning'
					onclick="auditStatus();"> 审核
				</a>
				<a auth=""class='btn btn-small btn-warning'
					onclick="finallyAudit();"> 最终审核
				</a>
				<a auth="" class="btn btn-small btn-info"
					onclick="reportData_04();">导出文件
				</a>
				</span>
			 <span id="paging_bar" style="float: right"> </span>
			</div>
			<!-- PAGE CONTENT ENDS -->
		</div>
		<!-- /.col -->
	</div>
	<!-- /.row -->

	<!-- page specific plugin scripts -->
	<script type="text/javascript">
	
	var jqGrid;
	jQuery(function($) {
		var grid_selector = "#grid-table";
		var pager_selector = "#grid-pager";

		$(window).on(
				'resize.jqGrid',
				function() {
					$(grid_selector).jqGrid('setGridWidth',$(".page-content").width());
				})
		var parent_column = $(grid_selector).closest('[class*="col-"]');
		$(document).on(
				'settings.ace.jqGrid',
				function(ev, event_name, collapsed) {
					if (event_name === 'sidebar_collapsed'|| event_name === 'main_container_fixed') {
						setTimeout(function() {
							$(grid_selector).jqGrid('setGridWidth',parent_column.width());
						}, 0);
					}
				})
		jQuery(grid_selector).jqGrid({
			url : "mpomng/prdInf/rechargePrdList.do",
			datatype : "json",
			height : '100%',
			width : '100%',
			colNames : [ '收款订单号','商户编号  ','商户名称','代理商编号','代理商名称','订单时间','订单状态','审核状态','审核时间','支付订单号','支付方式','终端号','订单金额','费率类型','费率','手续费','到账金额','支付渠道','银行账号','银行名称','卡片名称','上游商户号', '上游费率', '上游手续费', '应答码','应答消息','支付完成时间','批发类费率','批发类封顶金额'],
			colModel : [   {name : 'prdOrdNo',        index : 'prdOrdNo',        width : '140px',sortable:false}, 
						     {name : 'custId',        index : 'custId',          width : '120px',sortable:false }, 
						     {name : 'custName',        index : 'custName',      width : '80px',sortable:false },
						     {name : 'agentId',        index : 'agentId',        width : '120px',sortable:false }, 
						     {name : 'agentName',        index : 'agentName',    width : '80px',sortable:false },
						     {name : 'ordTime',        index : 'ordTime',        width : '140px',sortable:false,formatter : gridFormatByDate},
						     {name : 'ordStatus',        index : 'ordStatus',    width : '100px',sortable:false,ditcKey:'ORDSTATUS',formatter : gridFormatByDict }, 
						     {name : 'auditStatus',        index : 'auditStatus',    width : '100px',sortable:false,ditcKey:'AUDITCONDITION',formatter : gridFormatByDict }, 
						     {name : 'auditTime',        index : 'auditTime',        width : '140px',sortable:false,formatter : gridFormatByDate},
						     {name : 'payOrdNo',       index : 'payOrdNo',       width : '150px',sortable:false}, 
							 {name : 'payType',        index : 'payType',        width : '100px',sortable:false,ditcKey:'PAYTYPE',formatter : gridFormatByDict}, 
							 {name : 'terNo',        index : 'terNo',        	 width : '120px',sortable:false },  
						     {name : 'ordAmt',        index : 'ordAmt',        	 width : '100px',sortable:false,formatter : centYuan }, 
						     {name : 'rateType',        index : 'rateType',      width : '100px',sortable:false,ditcKey:'RATETYPE',formatter : gridFormatByDict }, 
						     {name : 'rate',        index : 'rate',        		 width : '100px',sortable:false ,formatter : formatByRate}, 
						     {name : 'fee',        index : 'fee',                width : '80px',sortable:false,formatter : centYuan } ,
						     {name : 'netrecAmt',        index : 'netrecamt',    width : '100px',sortable:false,formatter : centYuan } ,
						     {name : 'payChannel',        index : 'payChannel',  width : '100px',sortable:false ,ditcKey:'CHNAME',formatter : gridFormatByDict} ,
						     {name : 'payCardNo',        index : 'bankpayacno',  width : '160px',sortable:false } ,
						     {name : 'issNam',        index : 'issNam',        	 width : '150px',sortable:false } ,
						     {name : 'crdNam',        index : 'crdNam',          width : '180px',sortable:false } ,
						     {name : 'fathAgentId',    index : 'fathAgentId',    width : '120px',sortable:false },
						     {name : 'fathRate',        index : 'fathRate',      width : '100px',sortable:false }, 
						     {name : 'fathFee',        index : 'fathFee',        width : '80px',sortable:false,formatter : centYuan } ,
						     {name : 'tcpscod',        index : 'tcpscod',        width : '80px',sortable:false } ,
						     {name : 'cause',        index : 'cause',            width : '180px',sortable:false } ,
						     {name : 'payOrdTime',        index : 'payOrdTime',  width : '140px',sortable:false,formatter : gridFormatByDate},
						     {name : 'rateGeneralTop',    hidden : true,        index : 'rateGeneralTop',        width : '140px',sortable:false},
						     {name : 'rateGeneralMaximun',hidden : true,        index : 'rateGeneralMaximun',        width : '140px',sortable:false}
			            ],
			viewrecords : true,
			rowNum : 10,
			rowList : [ 10, 20, 30 ],
			altRows : true,
			shrinkToFit : false,
			multiselect : true,//设置行可多选的 
			multiboxonly : true,//

			loadComplete : function() {
				var table = this;
				setTimeout(function() {
					//加载分页
					initPagingBar(grid_selector);
				}, 0);
			},
			beforeRequest : function() {//请求之前执行
				jqGrid = this;
			},
		});
		$(window).triggerHandler('resize.jqGrid');

		$(document).one('ajaxloadstart.page', function(e) {
			$(grid_selector).jqGrid('GridUnload');
			$('.ui-jqdialog').remove();
		}); 
		
		//
		function formatByRate(cellvalue, options, rowObject){
			if(rowObject.rateType == '4'){
 				//return cent2Yuan(cellvalue);
// 				return '123';
				return rowObject.rateGeneralTop + ' - ' + cent2Yuan(rowObject.rateGeneralMaximun) + '封顶';
			}else{
				if(cellvalue==undefined){
					return "";
				}else{
					return cellvalue ;
				}
				
			}
			
		}
		
		function centYuan(cellvalue, options, rowObject) {
			return cent2Yuan(cellvalue);
		}
	});
	
	function rechargeDetails() {
		var rows = $('#grid-table').jqGrid("getGridParam", "selarrrow");
		if (rows.length == 0) {
			msg.alert("警告", "当前没有选择数据项！", "error");
			return;
		}
		if (rows.length > 1) {
			msg.alert("警告", "不能同时选择多项数据！", "warn");
			return;
		}
		var prdno = $('#grid-table').jqGrid('getRowData',rows[0]).prdOrdNo;
		var payno = $('#grid-table').jqGrid('getRowData',rows[0]).payOrdNo;
		var scrWidth = document.body.scrollWidth;
		openDialog({
			dialogId : 'dlg-rechargeDetail',
			title : '收款订单信息详情',
			pageUrl :'mpomng/prdInf/rechargeDetailsView.do',
			dataUrl : 'mpomng/prdInf/queryPrdDetails.do',
			width : '60%',
		    height:'90%',
			dataParam : {
				prdordno : prdno,
				payordno : payno
			},
			dataName : 'obj,map'//表单数据存储对象名称
		}); 		
	}
	
	function auditStatus() {
		var rows = $('#grid-table').jqGrid("getGridParam", "selarrrow");
		if (rows.length == 0) {
			msg.alert("警告", "当前没有选择数据项！", "error");
			return;
		}
		if (rows.length > 1) {
			msg.alert("警告", "不能同时选择多项数据！", "warn");
			return;
		}
		var prdno = $('#grid-table').jqGrid('getRowData',rows[0]).prdOrdNo;
		var payno = $('#grid-table').jqGrid('getRowData',rows[0]).payOrdNo;
		var custId = $('#grid-table').jqGrid('getRowData',rows[0]).custId;
		var netrecamt = $('#grid-table').jqGrid('getRowData',rows[0]).netrecAmt;
		
		if($('#grid-table').jqGrid('getRowData',rows[0]).auditStatus=='最终审核不通过'){
			msg.alert("警告", "最终审核不通过无法再次审核！", "warn");
		 	return false;
		}else if($('#grid-table').jqGrid('getRowData',rows[0]).auditStatus=='已审核'){
				msg.alert("警告", "审核已通过不能再次审核！", "warn");
		 		return false;
		}else if($('#grid-table').jqGrid('getRowData',rows[0]).auditStatus=='审核不通过'){
			msg.alert("警告", "审核不通过不能再次审核！", "warn");
	 		return false;
		}else if($('#grid-table').jqGrid('getRowData',rows[0]).ordStatus=='失败'){
			msg.alert("警告", "该订单状态为失败，不能审核！", "warn");
 			return false;
		}else if($('#grid-table').jqGrid('getRowData',rows[0]).ordStatus=='处理中'){
			msg.alert("警告", "该订单状态为处理中，不能审核！", "warn");
 			return false;
		}else if($('#grid-table').jqGrid('getRowData',rows[0]).ordStatus=='可疑'){
			msg.alert("警告", "该订单状态为可疑，不能审核！", "warn");
 			return false;
		}
		
		var nameAAA='1';
		var scrWidth = document.body.scrollWidth;
		openDialog({
			dialogId : 'dlg-rechargeAudit',
			title : '收款订单审核',
			pageUrl :'mpomng/prdInf/rechargeAuditView.do',
			dataUrl : 'mpomng/prdInf/queryPrdDetails.do',
			width : '45%',
			height:'70%',
			dataParam : {
				prdordno : prdno,
				payordno : payno,
				custId　: custId,
				checkAudit : '1',
				netrecamt : netrecamt*100
				
			},
			dataName : 'obj,map'//表单数据存储对象名称

		});
	}
	function finallyAudit() {
		var rows = $('#grid-table').jqGrid("getGridParam", "selarrrow");
		if (rows.length == 0) {
			msg.alert("警告", "当前没有选择数据项！", "error");
			return;
		}
		if (rows.length > 1) {
			msg.alert("警告", "不能同时选择多项数据！", "warn");
			return;
		}
		var prdno = $('#grid-table').jqGrid('getRowData',rows[0]).prdOrdNo;
		var payno = $('#grid-table').jqGrid('getRowData',rows[0]).payOrdNo;
		var custId = $('#grid-table').jqGrid('getRowData',rows[0]).custId;
		var netrecamt = $('#grid-table').jqGrid('getRowData',rows[0]).netrecAmt;
		if($('#grid-table').jqGrid('getRowData',rows[0]).auditStatus=='最终审核不通过'){
			msg.alert("警告", "最终审核不通过无法再次审核！", "warn");
		 	return false;
		}else if($('#grid-table').jqGrid('getRowData',rows[0]).auditStatus=='已审核'){
				msg.alert("警告", "审核已通过不能再次审核！", "warn");
		 		return false;
		}else if($('#grid-table').jqGrid('getRowData',rows[0]).auditStatus=='审核中'){
			msg.alert("警告", "只能审核不通过的！", "warn");
	 		return false;
	}
		
		var scrWidth = document.body.scrollWidth;
		openDialog({
			dialogId : 'dlg-rechargeAudit',
			title : '收款订单审核',
			pageUrl :'mpomng/prdInf/rechargeAuditView.do',
			dataUrl : 'mpomng/prdInf/queryPrdDetails.do',
			width : '45%',
			height:'70%',
			dataParam : {
				prdordno : prdno,
				payordno : payno,
				custId　: custId,
				netrecamt : netrecamt*100,
				checkAudit : '2',
			},
			dataName : 'obj,map'//表单数据存储对象名称

		});
	}
	
	  $(document).ready(function(){
		  searchCount();
	
	 });
	
	function searchCount(){
			 $.ajax({
					type : "post",
					url : "mpomng/prdInf/rechargeCount.do",
					data:$("#rechargeSearchForm").serialize(),
					dataType : 'json',
					async:true,
					success : function(result) {
						if (result.rspcod != 200) {
							msg.alert("错误", result.rspmsg, 'error');
						} else {
							count=result.obj.cntNum;
							txamt=cent2Yuan(result.obj.cntOrdAmt);
							fee=cent2Yuan(result.obj.cntFee);
							if(!count){
								count="0";
							}
							if(!txamt){
								txamt="0";
							}
							if(!fee){
								fee="0";
							}
							var html="";
							html+="汇总笔数和金额:["+count+"]笔  |  [" +txamt+ "]元  "
							html+="&nbsp;&nbsp;&nbsp;&nbsp;";
							html+="手续费总额:["+fee+"]元";
							$("#total").html(html);
							
						}
					},
					error : function(XMLHttpRequest, textStatus) {
						msg.alert("错误", "错误代码：" + XMLHttpRequest.status + ",错误描述："+ textStatus, 'error');
					}
				});
	
		
	}
	
	function reportData_04(){
		var prdOrdNo=$("#prdOrdNo").val();
		var custId=$("#custId").val();
		var custName=$("#custName").val();
		var agentId=$("#agentId").val();
		var agentName=$("#agentName").val();
		var bankpayacno=$("#bankpayacno").val();
		var search_paystatus=$("#search_paystatus").val();
		var payType=$("#payType").val();
		var prdDateStart=$("#prdDateStart").val();
		var prdDateEnd=$("#prdDateEnd").val();
		var querycon = {"prdOrdNo":prdOrdNo,
						"custId":custId,
						"custName":custName,
						"agentId":agentId,
						"agentName":agentName,
						"payCardNo":bankpayacno,
						"ordStatus":search_paystatus,
						"payType":payType,
						"startTime":prdDateStart,
						"endTime":prdDateEnd,
						"prdType":"02",
						"server":"04"
		};
		report(querycon);
	}
	
	function reportData_07(){
		var querycon = {
				"server":"07"
		};
		reportEsign(querycon);
	}
	
	
	
	
	</script>